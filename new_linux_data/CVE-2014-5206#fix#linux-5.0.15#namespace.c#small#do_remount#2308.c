static int do_remount(struct path *path, int ms_flags, int sb_flags,
		      int mnt_flags, void *data)
{
	int err;
	struct super_block *sb = path->mnt->mnt_sb;
	struct mount *mnt = real_mount(path->mnt);
	void *sec_opts = NULL;

	if (!check_mnt(mnt))
		return -EINVAL;

	if (path->dentry != path->mnt->mnt_root)
		return -EINVAL;

	if (!can_change_locked_flags(mnt, mnt_flags))
		return -EPERM;

	if (data && !(sb->s_type->fs_flags & FS_BINARY_MOUNTDATA)) {
		err = security_sb_eat_lsm_opts(data, &sec_opts);
		if (err)
			return err;
	}
	err = security_sb_remount(sb, sec_opts);
	security_free_mnt_opts(&sec_opts);
	if (err)
		return err;

	down_write(&sb->s_umount);
	err = -EPERM;
	if (ns_capable(sb->s_user_ns, CAP_SYS_ADMIN)) {
		err = do_remount_sb(sb, sb_flags, data, 0);
		if (!err)
			set_mount_attributes(mnt, mnt_flags);
	}
	up_write(&sb->s_umount);
	return err;
}
